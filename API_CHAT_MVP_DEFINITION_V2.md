# API Endpoint: `/assistant/chat`

This document describes the server-side API for the `/assistant/chat` endpoint and defines the scope for the Chatting MVP.

## 1. API Endpoint: `/assistant/chat`

*   **Method:** `POST`
*   **Authentication:** Required (e.g., via JWT passed in cookies, processed by `auth` middleware).
*   **Request Body:**
    The client must send a JSON object with the following properties:

    *   `message` (string, required): The user's chat message.
    *   `location` (object, required): User's current geographical location.
        *   `latitude` (number, required): Latitude.
        *   `longitude` (number, required): Longitude.

*   **Example Request Body:**

    ```json
    {
      "message": "What's the weather like here for tomorrow?",
      "location": {
        "latitude": 34.0522,
        "longitude": -118.2437
      }
    }
    ```

## 2. Server Responses

### Success Response (HTTP 200 OK)

*   **Content-Type:** `application/json`
*   **Outer Body Structure:** `{"response": <ASSISTANT_RESPONSE_OBJECT>}`
    The server returns a JSON object where the primary content is nested under a key named `response`.

*   **`ASSISTANT_RESPONSE_OBJECT` Structure:**
    This is the value of the `response` key from the outer body.

    *   `intent` (string): The primary intent determined by the `controlTower` (e.g., "weather_question", "general_question", "schedule_report", "system_error").
    *   `response` (string): The richly formatted conversational text response generated by `mainAssistant`. This text may contain markdown elements such as headings (e.g., `## Weather Details`), bullet points (e.g., `* Sunny with a chance of clouds.`), and bold text for emphasis. The client should be prepared to render this markdown.
    *   `formatType` (string): A hint for the client UI on how to best display the `response` and `rawData`. Example values include: "text", "weather_report", "schedule_list", "error", "research_summary", "confirmation_message".
    *   `rawData` (object):
        *   `sourceData` (object, optional): The original structured data from a specialized model (e.g., weather data, schedule list, research findings) if `mainAssistant` is presenting data from another source.
        *   `errorContext` (object, optional): Details about a system error if `formatType` is "error" and `mainAssistant` is presenting an error originating from a flow. Contains `flowName` and `message`.
        *   `assistantAnalysis` (object, optional): `mainAssistant`'s internal metadata (e.g., `{ "summary": "...", "user_intent_summary": "...", "next_step": { "suggestion": "...", "type": "..." } }`).
    *   `modelUsed` (string): Typically "mainAssistant".
    *   `toolUsed` (string|null): Primary tool used in the flow, if any.

*   **Example Success Response Body (Weather Report):**

    ```json
    {
      "response": {
        "intent": "weather_question",
        "response": "Okay, here's the weather for your current location for tomorrow:\n\n## Tomorrow (YYYY-MM-DD)\n*   Morning: Sunny, 18°C (feels like 17°C), 35% humidity, 0% chance of rain.\n*   Afternoon: Clear skies, 22°C (feels like 21°C), 30% humidity, 0% chance of rain.",
        "formatType": "weather_report",
        "rawData": {
          "sourceData": [
            { "datetime": "YYYY-MM-DD 09:00", "condition": "Sunny", "temperature": "18°C (feels like 17°C)", "humidity": "35%", "chance_of_rain": "0%", "chance_of_snow": "0%", "wind": "5 kph from NE", "uv_index": 4 },
            { "datetime": "YYYY-MM-DD 14:00", "condition": "Clear skies", "temperature": "22°C (feels like 21°C)", "humidity": "30%", "chance_of_rain": "0%", "chance_of_snow": "0%", "wind": "8 kph from N", "uv_index": 6 }
          ],
          "assistantAnalysis": {
            "summary": "Provided a weather forecast for tomorrow.",
            "user_intent_summary": "User asked for tomorrow's weather.",
            "next_step": {
              "suggestion": "Would you like to know about any other day?",
              "type": "question"
            },
            "metadata": {
              "topic": "weather",
              "tone": "helpful"
            }
          }
        },
        "modelUsed": "mainAssistant",
        "toolUsed": "weatherService"
      }
    }
    ```

### Error Response (HTTP 4xx/5xx - General Server/Auth Errors)

These are typically errors that occur outside the main AI processing flow, such as authentication failures caught by the `auth` middleware, malformed requests caught by the server framework before reaching the chat logic, or unhandled exceptions in the server's core request/response pipeline.

*   **Content-Type:** `application/json`
*   **Body Structure (for errors caught by `server.js` general error middleware):**

    ```json
    {
      "success": false,
      "data": null,
      "message": "A human-readable error message describing the issue (e.g., 'Authentication failed', 'Internal Server Error')."
    }
    ```
*   **Example General Error Response Body (e.g., HTTP 500):**

    ```json
    {
      "success": false,
      "data": null,
      "message": "Internal Server Error"
    }
    ```

*   **Note:** Errors gracefully handled by the AI flow (i.e., caught within a `chain` function in `handleAiService.js`) and presented by `mainAssistant` will be HTTP 200 OK with `formatType: "error"` in the `ASSISTANT_RESPONSE_OBJECT`, as described in the Success Response section. The 4xx/5xx responses are for more fundamental request/server issues not handled by the AI logic.

## 3. Chatting MVP Definition (Server-Side Focus)

### Core Functionality:

*   Receives user `message` and `location` (latitude, longitude) via POST to `/assistant/chat`.
*   Authenticates user (via `auth` middleware).
*   `controlTower` determines a single primary user `intent` and `flowKey` (for MVP, focuses on single-task resolution). Extracts `days` for weather if specified.
*   `handleAiService` executes the determined flow from `flowMap`.
*   All flows route their final output or error state through `mainAssistant`.
*   `mainAssistant` generates a conversational `response` string. This response is richly formatted (e.g., using markdown for headings, lists) when presenting structured data or errors.
*   `mainAssistant` determines a `formatType` for its response.
*   If presenting data from another source or a system error, `mainAssistant` includes the original `sourceModelOutput` (as `rawData.sourceData`) or `errorEncountered` details (as `rawData.errorContext`). Its own operational metadata is in `rawData.assistantAnalysis`.
*   A single, standardized JSON response (as detailed above) is returned to the client via the outer `{"response": <ASSISTANT_RESPONSE_OBJECT>}` structure.
*   Basic conversational context is maintained by `mainAssistant` across turns within a single server process/instance (due to module-level `chat` object).
*   Robust error handling within flows: caught errors are logged, and `mainAssistant` is invoked to provide a user-friendly error message. Critical fallback for `mainAssistant` or `controlTower` failures.

### Supported Flows/Intents for MVP (Examples):

*   `generalQuestion` (direct Q&A with `mainAssistant`).
*   `weatherQuestion` (utilizing `weatherService` with `days` parameter).
*   `generalQuestionWithWebSearch` (if web search tool is stable).
*   Error presentation flow (via `systemErrorPresentation` context to `mainAssistant`).

### Out of Scope for Initial MVP (Examples):

*   `handleAiService` processing and aggregating responses from multiple tasks identified by `controlTower` in a single turn. (MVP processes first task).
*   Persistent, cross-session user memory or deep personalization.
*   Client-side implementation of all `formatType` renderings (server provides the types; client MVP might initially render complex ones as formatted text).
*   Complex multi-turn conversational flows requiring explicit state management beyond `mainAssistant`'s current capabilities.
*   `researchTask` and `schedule*` flows (while infrastructure may exist, full MVP inclusion depends on stability).
```
